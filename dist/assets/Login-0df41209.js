import{d as T,r as u,s as B,J as G,o as W,ac as h,y as a,f as L,g as n,h as r,j as s,t as V,m as i,l as p,q as _,an as y,v as k,p as A,_ as D}from"./index-2c888479.js";import{j as M}from"./index-bcdd064d.js";const K={class:"flex flex-col mt-8 flex-1 items-center bg-white rounded-md p-10"},$={class:"w-96"},J={class:"text-center mb-8"},X={class:"text-gray-600"},F={class:"space-y-6"},H={class:"flex justify-center"},P=["disabled"],R={key:0,class:"text-sm font-medium text-gray-600"},Y={key:1,class:"flex items-center"},Z={class:"flex justify-center"},ee=["disabled"],te={key:0,class:"text-sm font-medium text-gray-600"},se={key:1,class:"flex items-center"},oe={key:0,class:"text-center"},ae={key:1,class:"text-center"},ne=T({__name:"Login",setup(re){const q=u("一方工具箱"),w=u("https://tool.fologde.com"),x=u(!1),l=u(!1),d=u(!1),E=u(!1),c=B(),Q="825228691844-jflrvsfqa82gs1s225qbcaa4raujmp1f.apps.googleusercontent.com",S=G(()=>c.getLoginStatus);W(()=>{if(c.initUserState(),c.getLoginStatus){window.location.href="/userinfo";return}const e=document.createElement("script");e.src="https://accounts.google.com/gsi/client",e.async=!0,e.defer=!0,e.onload=()=>{E.value=!0,j()},document.head.appendChild(e),window.addEventListener("message",N)});const j=()=>{if(typeof window.google<"u"){window.google.accounts.id.initialize({client_id:Q,callback:I,auto_select:!1,cancel_on_tap_outside:!0});const e=document.getElementById("google-signin-button");e&&window.google.accounts.id.renderButton(e,{theme:"outline",size:"large",type:"standard",text:"signin_with",shape:"rectangular",logo_alignment:"left",width:400})}},I=async e=>{if(e.credential){x.value=!0;try{const t=await h.post("/google-auth",{credential:e.credential});if(t.data.success){const o=M(t.data.token);console.log("jwt",o),a.success(`欢迎回来，${o.username}！`),localStorage.setItem("TOKEN",t.data.token),c.initUserState(),window.location.href="/userinfo"}else throw new Error(t.data.error||"认证失败")}catch(t){a.error("谷歌登录失败，请重试"),console.error("Google sign-in error:",t)}finally{x.value=!1}}},C=async()=>{try{l.value=!0;const e=await h.post(w.value+"/linuxdo-auth",{params:{action:"getAuthUrl"}});if(!e.data.success)throw new Error("Linux.do登录配置错误");if(!window.open(e.data.auth_url,"linuxdo-auth","width=600,height=600,scrollbars=yes,resizable=yes"))throw new Error("无法打开登录窗口，请检查浏览器弹窗设置")}catch(e){console.error("Linux.do login error:",e),a.error("Linux.do登录失败，请重试"),l.value=!1}},z=async()=>{try{d.value=!0;const e=await h.post(w.value+"/qq-auth",{params:{action:"getAuthUrl"}});if(!e.data.success)throw new Error("QQ登录配置错误");if(!window.open(e.data.auth_url,"qq-auth","width=600,height=600,scrollbars=yes,resizable=yes"))throw new Error("无法打开登录窗口，请检查浏览器弹窗设置")}catch(e){console.error("QQ login error:",e),a.error("QQ登录失败，请重试"),d.value=!1}},N=e=>{var o,f,b,v;if(["https://connect.linux.do","https://graph.qq.com",w.value,window.location.origin].some(g=>e.origin.startsWith(g))&&!(!e.data||typeof e.data!="object")&&["success","error"].includes((o=e.data)==null?void 0:o.type))if(((f=e.data)==null?void 0:f.type)==="success"){if(!((b=e.data.data)!=null&&b.token)||!((v=e.data.data)!=null&&v.user)){console.warn("Login success message missing required data");return}l.value=!1,d.value=!1;const{token:g,user:m,message:U}=e.data.data;a.success(U||`欢迎回来，${m.username}！`),localStorage.setItem("TOKEN",g),c.initUserState(),setTimeout(()=>{window.location.href="/userinfo"},1e3)}else{l.value=!1,d.value=!1;const{error:g,message:m}=e.data;console.error("Login auth error:",g,m),a.error(m||"登录失败，请重试")}},O=()=>{typeof window.google<"u"&&window.google.accounts.id.disableAutoSelect(),c.logout(),a.success("已退出登录")};return(e,t)=>{const o=L("el-icon"),f=L("el-button");return n(),r("div",K,[s("div",$,[s("div",J,[t[0]||(t[0]=s("h1",{class:"text-3xl font-bold text-gray-800 mb-2"},"用户登录",-1)),s("p",X,"欢迎使用"+V(q.value),1)]),s("div",F,[t[7]||(t[7]=s("div",{class:"flex justify-center"},[s("div",{id:"google-signin-button"})],-1)),s("div",H,[s("button",{onClick:C,disabled:l.value,class:"flex items-center justify-center w-full max-w-[400px] h-[40px] border border-gray-300 rounded-md bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[t[2]||(t[2]=s("img",{src:"https://linux.do/uploads/default/original/4X/c/c/d/ccd8c210609d498cbeb3d5201d4c259348447562.png",alt:"Linux.do",class:"w-5 h-5 mr-3"},null,-1)),l.value?(n(),r("div",Y,[i(o,{class:"is-loading mr-2"},{default:p(()=>[i(_(y))]),_:1}),t[1]||(t[1]=s("span",{class:"text-sm text-gray-600"},"登录中...",-1))])):(n(),r("span",R," 使用 Linux.do 登录 "))],8,P)]),s("div",Z,[s("button",{onClick:z,disabled:d.value,class:"flex items-center justify-center w-full max-w-[400px] h-[40px] border border-gray-300 rounded-md bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[t[4]||(t[4]=s("img",{src:"https://qq-web.cdn-go.cn//im.qq.com_new/7bce6d6d/asset/favicon.ico",alt:"QQ",class:"w-5 h-5 mr-3"},null,-1)),d.value?(n(),r("div",se,[i(o,{class:"is-loading mr-2"},{default:p(()=>[i(_(y))]),_:1}),t[3]||(t[3]=s("span",{class:"text-sm text-gray-600"},"登录中...",-1))])):(n(),r("span",te," 使用 QQ 登录 "))],8,ee)]),t[8]||(t[8]=s("div",{class:"flex items-center"},[s("div",{class:"flex-1 border-t border-gray-200"}),s("span",{class:"px-3 text-sm text-gray-500"},"或"),s("div",{class:"flex-1 border-t border-gray-200"})],-1)),x.value?(n(),r("div",oe,[i(o,{class:"is-loading"},{default:p(()=>[i(_(y))]),_:1}),t[5]||(t[5]=s("span",{class:"ml-2 text-gray-600"},"登录中...",-1))])):k("",!0),t[9]||(t[9]=s("div",{class:"text-center text-gray-500 text-sm"},[s("p",null,"支持谷歌账号、Linux.do账号和QQ账号登录"),s("p",{class:"mt-2"},"登录后可以享受更多个性化功能")],-1)),S.value?(n(),r("div",ae,[i(f,{type:"danger",size:"small",onClick:O},{default:p(()=>t[6]||(t[6]=[A(" 退出登录 ",-1)])),_:1,__:[6]})])):k("",!0)])])])}}});const de=D(ne,[["__scopeId","data-v-6d7ab4a9"]]);export{de as default};
