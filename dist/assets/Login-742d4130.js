import{d as U,r as l,s as B,J as G,o as q,ac as w,y as r,f as y,g as d,h as c,j as s,t as V,m as u,l as p,q as h,an as b,v,p as D,_ as M}from"./index-63e0987a.js";import{j as W}from"./index-bcdd064d.js";const A={class:"flex flex-col mt-8 flex-1 items-center bg-white rounded-md p-10"},K={class:"w-96"},$={class:"text-center mb-8"},J={class:"text-gray-600"},X={class:"space-y-6"},F={class:"flex justify-center"},H=["disabled"],P={key:0,class:"text-sm font-medium text-gray-600"},Q={key:1,class:"flex items-center"},R={key:0,class:"text-center"},Y={key:1,class:"text-center"},Z=U({__name:"Login",setup(ee){const L=l("一方工具箱"),S=l("https://tool.fologde.com"),m=l(!1),a=l(!1),k=l(!1),n=B(),E="825228691844-jflrvsfqa82gs1s225qbcaa4raujmp1f.apps.googleusercontent.com",j=G(()=>n.getLoginStatus);q(()=>{if(n.initUserState(),n.getLoginStatus){window.location.href="/userinfo";return}const e=document.createElement("script");e.src="https://accounts.google.com/gsi/client",e.async=!0,e.defer=!0,e.onload=()=>{k.value=!0,I()},document.head.appendChild(e),window.addEventListener("message",O)});const I=()=>{if(typeof window.google<"u"){window.google.accounts.id.initialize({client_id:E,callback:C,auto_select:!1,cancel_on_tap_outside:!0});const e=document.getElementById("google-signin-button");e&&window.google.accounts.id.renderButton(e,{theme:"outline",size:"large",type:"standard",text:"signin_with",shape:"rectangular",logo_alignment:"left",width:400})}},C=async e=>{if(e.credential){m.value=!0;try{const t=await w.post("/google-auth",{credential:e.credential});if(t.data.success){const o=W(t.data.token);console.log("jwt",o),r.success(`欢迎回来，${o.username}！`),localStorage.setItem("TOKEN",t.data.token),n.initUserState(),window.location.href="/userinfo"}else throw new Error(t.data.error||"认证失败")}catch(t){r.error("谷歌登录失败，请重试"),console.error("Google sign-in error:",t)}finally{m.value=!1}}},N=async()=>{try{a.value=!0;const e=await w.post(S.value+"/linuxdo-auth",{params:{action:"getAuthUrl"}});if(!e.data.success)throw new Error("Linux.do登录配置错误");if(!window.open(e.data.auth_url,"linuxdo-auth","width=600,height=600,scrollbars=yes,resizable=yes"))throw new Error("无法打开登录窗口，请检查浏览器弹窗设置")}catch(e){console.error("Linux.do login error:",e),r.error("Linux.do登录失败，请重试"),a.value=!1}},O=e=>{var o,g,x,_;if(["https://connect.linux.do"].some(i=>e.origin.startsWith(i))&&!(!e.data||typeof e.data!="object")&&["success","error"].includes((o=e.data)==null?void 0:o.type))if(((g=e.data)==null?void 0:g.type)==="success"){if(!((x=e.data.data)!=null&&x.token)||!((_=e.data.data)!=null&&_.user)){console.warn("Linux.do success message missing required data");return}a.value=!1;const{token:i,user:f,message:T}=e.data.data;r.success(T||`欢迎回来，${f.username}！`),localStorage.setItem("TOKEN",i),n.initUserState(),setTimeout(()=>{window.location.href="/userinfo"},1e3)}else{a.value=!1;const{error:i,message:f}=e.data;console.error("Linux.do auth error:",i,f),r.error(f||"Linux.do登录失败，请重试")}},z=()=>{typeof window.google<"u"&&window.google.accounts.id.disableAutoSelect(),n.logout(),r.success("已退出登录")};return(e,t)=>{const o=y("el-icon"),g=y("el-button");return d(),c("div",A,[s("div",K,[s("div",$,[t[0]||(t[0]=s("h1",{class:"text-3xl font-bold text-gray-800 mb-2"},"用户登录",-1)),s("p",J,"欢迎使用"+V(L.value),1)]),s("div",X,[t[5]||(t[5]=s("div",{class:"flex justify-center"},[s("div",{id:"google-signin-button"})],-1)),s("div",F,[s("button",{onClick:N,disabled:a.value,class:"flex items-center justify-center w-full max-w-[400px] h-[40px] border border-gray-300 rounded-md bg-white hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},[t[2]||(t[2]=s("img",{src:"https://linux.do/uploads/default/original/4X/c/c/d/ccd8c210609d498cbeb3d5201d4c259348447562.png",alt:"Linux.do",class:"w-5 h-5 mr-3"},null,-1)),a.value?(d(),c("div",Q,[u(o,{class:"is-loading mr-2"},{default:p(()=>[u(h(b))]),_:1}),t[1]||(t[1]=s("span",{class:"text-sm text-gray-600"},"登录中...",-1))])):(d(),c("span",P," 使用 Linux.do 登录 "))],8,H)]),t[6]||(t[6]=s("div",{class:"flex items-center"},[s("div",{class:"flex-1 border-t border-gray-200"}),s("span",{class:"px-3 text-sm text-gray-500"},"或"),s("div",{class:"flex-1 border-t border-gray-200"})],-1)),m.value?(d(),c("div",R,[u(o,{class:"is-loading"},{default:p(()=>[u(h(b))]),_:1}),t[3]||(t[3]=s("span",{class:"ml-2 text-gray-600"},"登录中...",-1))])):v("",!0),t[7]||(t[7]=s("div",{class:"text-center text-gray-500 text-sm"},[s("p",null,"支持谷歌账号和Linux.do账号登录"),s("p",{class:"mt-2"},"登录后可以享受更多个性化功能")],-1)),j.value?(d(),c("div",Y,[u(g,{type:"danger",size:"small",onClick:z},{default:p(()=>t[4]||(t[4]=[D(" 退出登录 ",-1)])),_:1,__:[4]})])):v("",!0)])])])}}});const oe=M(Z,[["__scopeId","data-v-e36c4b6a"]]);export{oe as default};
